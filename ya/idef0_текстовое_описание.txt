2.1 Описание процесса в нотации IDEF0 (текстовое описание)

В нотации IDEF0 для каждого блока указываются:
I (Input) — входы; C (Control) — управление; O (Output) — выходы; M (Mechanism) — механизмы.


Контекстная диаграмма A-0: «Управление треками и плейлистами в приложении Playlist Maker»

Назначение:
Приложение обеспечивает поиск треков во внешнем каталоге, просмотр карточки трека, работу с «Избранным», создание и ведение плейлистов, а также настройку темы и выполнение сервисных действий (шаринг/поддержка/соглашение).

I (Входы):
1) Поисковый запрос пользователя (строка).
2) Выбранный трек (данные трека из результатов поиска).
3) Данные плейлиста (название, описание, обложка).
4) Команды пользователя (добавить/удалить из избранного, добавить/удалить трек из плейлиста, создать/удалить плейлист, объединить плейлисты, изменить тему, открыть «Поделиться/Поддержка/Соглашение»).

C (Управление):
1) Техническое задание и требования к UX/UI.
2) Ограничения платформы Android (жизненный цикл, безопасность, работа с сетью).
3) Контракт iTunes Search API (формат запроса/ответа, доступность сети).
4) Правила локального хранения (структура Room; правила DataStore; ограничение истории поиска до 10 записей).

O (Выходы):
1) Список найденных треков и состояния поиска (успех/пусто/ошибка/повтор).
2) Карточка трека (детальная информация).
3) Список избранных треков.
4) Список плейлистов и содержимое выбранного плейлиста.
5) Обновлённые данные в локальных хранилищах (Room, DataStore).
6) Переходы между экранами приложения.

M (Механизмы):
1) Пользователь и мобильное устройство (Android-смартфон/эмулятор).
2) UI: Jetpack Compose + Material 3 + Navigation Compose.
3) ViewModel + Kotlin Coroutines/Flow для управления состояниями.
4) Сеть: Retrofit/OkHttp/Gson для обращений к iTunes Search API.
5) Локальная БД: Room (TrackDao/PlaylistDao, сущности TrackEntity/PlaylistEntity).
6) DataStore Preferences (история поиска, настройки).


Диаграмма A0 (верхний уровень): «Управление треками и плейлистами»

Декомпозиция A0 на функции:
A1 «Поиск и просмотр треков»
A2 «Управление избранными треками»
A3 «Управление плейлистами»
A4 «Настройки и сервисные действия»

Основные связи между функциями:
1) A1 формирует «выбранный трек» и передаёт его в A2 (для изменения статуса favorite) и в A3 (для добавления трека в плейлист).
2) A2 обновляет статус favorite в локальной БД и обеспечивает корректное отображение этого статуса в A1 (карточка трека и списки).
3) A3 управляет плейлистами и предоставляет A1 список плейлистов для операции «Добавить в плейлист».
4) A4 сохраняет и применяет настройки (тема) и инициирует системные действия через Intent (шаринг/поддержка/соглашение).


Диаграмма A1 (декомпозиция): «Поиск и просмотр треков» (пример: 5 блоков)

A1.1 «Принять и проверить запрос»
I (Входы):
- строка поискового запроса из поля ввода;
- команда пользователя «поиск/повторить/очистить» (события UI).
C (Управление):
- правило: при пустом/пробельном запросе (isBlank) поиск не выполняется, состояние сбрасывается в Initial;
- правило: сохранять последний непустой запрос (lastQuery) для функции повторного поиска;
- правило: нормализация ввода (trim применяется при сетевом запросе и при сохранении истории).
O (Выходы):
- нормализованный запрос для поиска (непустой);
- значение lastQuery для повторного запроса;
- изменение состояния поиска: Initial (если запрос пустой) или переход к запуску поиска (Searching).
M (Механизмы):
- UI (Compose-экран поиска) как источник событий;
- SearchViewModel (методы searchTracks/clearSearch/retryLastQuery);
- Kotlin Coroutines (viewModelScope, Dispatchers.IO).

A1.2 «Выполнить сетевой поиск»
I (Входы):
- строка запроса (term) из A1.1.
C (Управление):
- контракт iTunes Search API (параметр term, формат ответа JSON);
- доступность сети и обработка ошибок ввода-вывода (IOException);
- настройки клиента Retrofit/OkHttp/Gson (базовый URL, конвертер JSON).
O (Выходы):
- список найденных сущностей TrackDto (результат ответа API);
- либо сообщение об ошибке (для формирования состояния Fail).
M (Механизмы):
- ITunesApiService (Retrofit-интерфейс);
- OkHttp + Gson Converter;
- TracksRepositoryImpl/TracksRepository.

A1.3 «Преобразовать и согласовать данные»
I (Входы):
- список TrackDto (результат A1.2);
- локальные записи TrackEntity из Room по идентификаторам найденных треков (при наличии).
C (Управление):
- правила преобразования DTO → доменную модель Track:
  * форматирование длительности (trackTimeMillis → "mm:ss");
  * увеличение URL обложки (artworkUrl100: "100x100bb" → "512x512bb");
  * определение года (releaseDate.take(4) либо резервное поле year);
  * определение альбома (collectionName либо резервное поле album);
- правила согласования с локальными данными:
  * если трек уже есть в БД, переносить favorite и playlistId в результирующую модель;
  * использовать локальные artworkUrl/coverResId как fallback, если соответствующие поля отсутствуют в данных API.
O (Выходы):
- список доменных объектов Track, готовый к отображению и дальнейшим операциям (выбор, избранное, добавление в плейлист).
M (Механизмы):
- TracksRepositoryImpl (маппинг TrackDto.toDomain и merge с локальными данными);
- Room/TrackDao (getByIds/getById);
- Kotlin коллекции и функции преобразования.

A1.4 «Сохранить запрос в историю»
I (Входы):
- исходный запрос пользователя (строка);
- текущее содержимое истории (DataStore Preferences).
C (Управление):
- правило: trim и проверка на пустоту (пустые значения не сохранять);
- правило: удалять дубли без учёта регистра (equals ignoreCase);
- правило: добавлять новый запрос в начало списка;
- ограничение: MAX_ENTRIES = 10;
- формат хранения: одна строка с разделителем "," (SEPARATOR).
O (Выходы):
- обновлённая история поиска, сохранённая в DataStore;
- обновлённый поток history: Flow<List<String>> для отображения в UI.
M (Механизмы):
- SearchHistoryRepositoryImpl/SearchHistoryRepository;
- SearchHistoryPreferences (DataStore Preferences);
- Kotlin Coroutines (вызов из Dispatchers.IO).
Примечание: в текущей реализации запрос добавляется в историю после успешного получения списка результатов поиска.

A1.5 «Отобразить результат и состояния»
I (Входы):
- SearchState: Initial/Searching/Success(tracks)/Fail(message);
- список Track (при Success);
- история запросов (history: Flow<List<String>>);
- действия пользователя: повторить запрос, выбрать трек, очистить историю/поиск.
C (Управление):
- правила UI-представления по состояниям:
  * Searching — отображается загрузка;
  * Success + пустой список — отображается состояние «ничего не найдено»;
  * Fail — отображается ошибка и возможность повтора (retryLastQuery);
  * Initial — отображается стартовый экран и блок истории;
- правила выбора трека: при нажатии на элемент списка устанавливается selectedTrack и выполняется переход на экран деталей.
O (Выходы):
- отображённый на экране список результатов/состояние поиска;
- выбранный трек (selectedTrack) для отображения карточки трека;
- инициированный повторный поиск/очистка (в зависимости от действий пользователя).
M (Механизмы):
- SearchScreen/DetailScreen (Jetpack Compose);
- SearchViewModel (StateFlow searchState/selectedTrack, Flow history);
- Navigation Compose (переходы между экранами);
- Material 3 компоненты (кнопки/списки/индикаторы).


Диаграмма A2 (декомпозиция): «Управление избранными треками»

Состав функций:
A2.1 «Показать список избранного»
A2.2 «Изменить статус favorite»
A2.3 «Сохранить/получить избранное из БД»

A2.1 «Показать список избранного»
I: список избранных треков из локальной БД.
C: правила отображения UI и обновления списка (Flow/StateFlow).
O: отображённый список «Избранное».
M: Compose UI (экран избранного), ViewModel, Flow.

A2.2 «Изменить статус favorite»
I: выбранный трек; команда пользователя «в избранное/из избранного».
C: бизнес-правила целостности (уникальность; согласование статуса на карточке трека).
O: новое значение favorite; команда на обновление БД.
M: SearchViewModel/TracksRepository.

A2.3 «Сохранить/получить избранное из БД»
I: запрос на получение списка избранного; команда на вставку/обновление трека.
C: схема Room (TrackEntity/TrackDao), правила записи/чтения.
O: обновлённый список избранного (Flow) и сохранённые значения.
M: Room Database, DAO, Coroutines/Flow.


Диаграмма A3 (декомпозиция): «Управление плейлистами»

Состав функций:
A3.1 «Создать/редактировать плейлист»
A3.2 «Показать список плейлистов и детали плейлиста»
A3.3 «Добавить трек в плейлист»
A3.4 «Удалить/объединить плейлисты и управлять содержимым»

A3.1 «Создать/редактировать плейлист»
I: данные плейлиста (название, описание, обложка); команда «создать/сохранить».
C: правила валидации (название обязательно и т. п.).
O: созданный/обновлённый плейлист в БД.
M: Compose UI, PlaylistsViewModel, Room.

A3.2 «Показать список плейлистов и детали плейлиста»
I: список плейлистов; выбранный плейлист.
C: правила отображения UI (пустой список/обновления по Flow).
O: отображение списка плейлистов и содержимого выбранного плейлиста.
M: Compose UI, Flow из Room (репозиторий плейлистов).

A3.3 «Добавить трек в плейлист»
I: выбранный трек; выбранный плейлист.
C: правило недопущения дублей и корректного обновления содержимого плейлиста.
O: обновлённое содержимое плейлиста; подтверждение действия пользователю.
M: PlaylistsViewModel/Repository, Room (DAO), Coroutines.

A3.4 «Удалить/объединить плейлисты и управлять содержимым»
I: команда «удалить трек/удалить плейлист/объединить»; идентификаторы сущностей.
C: правила целостности (перенос треков при объединении, удаление связей).
O: обновлённые плейлисты и их содержимое.
M: Room, репозитории, Coroutines.


Диаграмма A4 (декомпозиция): «Настройки и сервисные действия»

Состав функций:
A4.1 «Сменить тему оформления»
A4.2 «Поделиться приложением»
A4.3 «Обратиться в поддержку»
A4.4 «Открыть пользовательское соглашение»

A4.1 «Сменить тему оформления»
I: выбор пользователя (режим темы).
C: правило сохранения и применения при запуске.
O: сохранённое значение темы; применённая тема интерфейса.
M: DataStore Preferences, тема Jetpack Compose.

A4.2 «Поделиться приложением»
I: команда пользователя «Поделиться».
C: правила формирования Intent ACTION_SEND.
O: открыто системное меню шаринга с подготовленным текстом/ссылкой.
M: Android Intent, системные приложения.

A4.3 «Обратиться в поддержку»
I: команда пользователя «Написать в поддержку».
C: шаблон темы/текста письма.
O: открыто почтовое приложение с предзаполненными полями.
M: Android Intent (mailto:), почтовый клиент.

A4.4 «Открыть пользовательское соглашение»
I: команда пользователя «Соглашение».
C: URL соглашения и правила открытия внешних ссылок.
O: открыт браузер по URL соглашения.
M: Android Intent (ACTION_VIEW), браузер.


2.2 Описание процесса в нотации DFD (текстовое описание)

На рисунке представлена DFD-диаграмма потоков данных приложения «Playlist Maker», описывающая поиск треков, работу с избранными треками и управление плейлистами.

Внешние сущности:
E1 «Пользователь» — формирует запрос на поиск, выбирает треки, выполняет действия над выбранным треком, создаёт/удаляет плейлисты.
E2 «ItunesAPI» — внешний источник данных, принимающий запросы поиска и возвращающий список треков.

Хранилища данных:
D1 «DataStore» — хранит историю поисковых запросов пользователя (последние запросы, ограничение по количеству записей).
D2 «Room DataBase» — локальная база данных Room; хранит сущности треков и плейлистов (в т. ч. признаки favorite и принадлежность трека плейлисту).
Примечание: на схеме D2 может быть показано в двух местах для наглядности, при этом это одно и то же хранилище.

Процессы (функции) и их назначение:
1 «Поиск трека» — принимает запрос на поиск от пользователя, при необходимости обращается к истории поиска в D1, отправляет запрос к E2 и получает список треков для отображения результатов.
2 «Управление выбранным треком» — обрабатывает действия пользователя над выбранным треком (выбор, добавление/удаление из избранного, добавление в плейлист), сохраняет изменения в D2 («сохранённый трек») и обеспечивает обновление интерфейса вкладки «Избранные треки».
3 «Управление плейлистами» — принимает запросы пользователя на создание/удаление плейлиста, получает «список плейлистов» из D2, записывает изменения в D2 («созданный плейлист», «удалённый плейлист») и формирует данные для интерфейса вкладки «Плейлисты».
4 «Просмотр избранных треков» — запрашивает в D2 «список треков из избранных» и отображает его пользователю.
5 «Просмотр плейлистов» — отображает список плейлистов и содержимое выбранного плейлиста; получает из D2 «список треков из плейлиста» и выводит данные пользователю.

Описание основных потоков данных:
1) E1 → 1: «Запрос на поиск» (ввод запроса пользователем).
2) 1 ↔ D1: «История поиска» (чтение для отображения/повтора и запись нового запроса при выполнении поиска).
3) 1 → E2: «Запрос к API» (вызов внешнего сервиса поиска).
4) E2 → 1: «Список треков» (результаты поиска).
5) 1 → 2: «Действия пользователя над треком» (выбор трека и операции с ним).
6) 2 → D2: «Сохранённый трек» (запись/обновление данных трека: favorite и/или привязка к плейлисту).
7) 2 → 4: «Интерфейс вкладки “Избранные треки”» (переход/обновление данных экрана избранного).
8) D2 → 4: «Список треков из избранных» (чтение избранных треков из базы данных).
9) E1 → 3: «Запрос на создание или удаление плейлиста» (команды управления плейлистами).
10) 3 ↔ D2: «Список плейлистов» (чтение), «Созданный плейлист» и «Удалённый плейлист» (запись изменений).
11) 3 → 5: «Интерфейс вкладки “Плейлисты”» (переход/обновление данных экрана плейлистов).
12) D2 → 5: «Список треков из плейлиста» (чтение содержимого выбранного плейлиста для отображения).
